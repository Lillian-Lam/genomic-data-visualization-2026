---
layout: post
title:  "CODEX Spleen Analysis: WP"
author: Sakshi Singhal
jhed: ssingha9
categories: [ HW5 ]
image: homework/hw5/hw5_ssingha9.png
featured: false
---

##Description:
To summarize the process of what I did: I started by filtering out low quality cells, removing the bottom and top 1% by total signal and cell area to get rid of dead cells, doublets and extreme cells. This left me with 9,599 out of 10,000 cells. I then normalized expression per cell and log10 transformed the values. I ran PCA and looked at a scree plot to pick 18 PCs, which I passed into tSNE for visualization. For clustering I used k-means with k=5, which I picked based on where the elbow plot started to relatively flatten. To find marker proteins for each cluster I ran a Wilcoxon test comparing each cluster against all other cells. I did not just take the most significant hits. I first filtered to proteins where the mean expression was higher inside the cluster than outside, so I could be sure I was selecting genuinely upregulated markers rather than just differentially expressed ones.

Cluster 5 had CD3e, CD4, CD45RO, CD45, and CD44 as its top upregulated markers. CD3e and CD4 are the standard markers for helper T cells [1]. Spatially, this cluster forms tight condensed regions in the tissue. According to literature, CD3 stains T lymphocytes specifically in periarteriolar lymphoid sheaths (PALS), which is the T cell zone of the white pulp [2] [3]. Literature also confirms that naive and central memory T cells migrate from the red pulp to the white pulp by following chemotactic gradients, and once they reach the T zone of the white pulp, they search for dendritic cells that can potentially present cognate antigens originating from blood [4]. The spatial pattern I see, with this cluster forming small dense islands in the tissue, is consistent with how PALS regions are described in the literature [5].

Cluster 4 had CD20, CD21, CD35, CD44, and HLA-DR as its top upregulated markers. CD20 is the standard B cell marker and CD19 and CD20 are primary markers for B cells, commonly used in immunohistochemistry to identify B cells in tissues, and CD20 is expressed during B cell development but is absent in plasma cells [6] [7] . CD21 and CD35 further support a follicular B cell identity because CD21 and CD23 are markers expressed on follicular dendritic and B cells, particularly in germinal centers, and are useful in identifying B cell follicles and follicular zones within lymphoid tissues [9]. Spatially, this cluster forms large rounded nodular structures in the tissue sitting adjacent to the T cell regions, which matches the expected architecture of B cell follicles in the white pulp [16]. Literature also confirms that CD20 stains B lymphocytes, particularly in follicles [10] . Buckner et al (2007) even states “CD20 has long been thought to be a specific marker for B-cell lineage and has been used to help differentiate T-cell and B-cell neoplasms” [10]

Based on these two clusters I believe this tissue is white pulp. The other options do not fit. Red pulp would be dominated by macrophage markers like CD68, CD163, and CD169, and none of my chosen clusters show that pattern [11]. Capsule and trabecula would show fibroblast and smooth muscle markers, not lymphocytes [12]. Artery and vein would be defined by endothelial markers like CD31 and CD34 [13] [14] [15]. The co-presence of spatially distinct T cell and B cell populations organizing into PALS-like and follicular structures is the defining feature of white pulp. As literature describes, the T cell regions of human spleens may be interrupted by B cell follicles, and T and B cell compartments are intricately interdigitated in the human splenic white pulp [16]. That interdigitated pattern of T cell zones and B cell follicles is exactly what I see in the spatial plots for clusters 4 and 5.

To conclude, the marker profiles and spatial organization of both clusters point to one answer. A CD3e/CD4 positive T cell population forming dense condensed regions alongside a CD20/CD21/CD35 positive B cell population forming large adjacent nodular structures is the hallmark organization of white pulp, and I am confident that is what this dataset represents
References
[1] https://www.vinmec.com/eng/blog/learn-about-the-cd3-cd4-cd8-count-test-en 
[2] https://pmc.ncbi.nlm.nih.gov/articles/PMC6495537/ 
[3]https://www.ncbi.nlm.nih.gov/gene/916#:~:text=Summary,Patient%20with%20Severe%20Combined%20Immunodeficiency. 
[4]https://pmc.ncbi.nlm.nih.gov/articles/PMC7609538/#:~:text=Immune%20cells%20passively%20enter%20the,zones%20in%20the%20white%20pulp. 
[5]https://www.pathologyoutlines.com/topic/spleennormalanatomy.html#:~:text=Microscopic%20(histologic)%20description-,Capsule,lymphocytes%20with%20an%20eccentric%20artery 
[6]https://www.abcam.com/en-us/technical-resources/research-areas/marker-guides/b-cell-markers 
[7] https://www.novusbio.com/products/cd20-antibody-l26_nbp2-48307 
[8] https://e-century.us/files/ijcep/9/8/ijcep0029454.pdf 
[9] https://pmc.ncbi.nlm.nih.gov/articles/PMC3256970/ 
[10] https://www.annclinlabsci.org/content/37/3/263.full 
[11] https://pmc.ncbi.nlm.nih.gov/articles/PMC5916003/ 
[12] https://pubmed.ncbi.nlm.nih.gov/1200408/ 
[13] https://www.frontiersin.org/journals/oncology/articles/10.3389/fonc.2022.956451/full 
[14]https://www.sciencedirect.com/science/article/pii/S001448001730076X#:~:text=next%20several%20years.-,Here%20we%20present%20the%20most%20commonly%20used%20endothelial%20cell%20markers,et%20al.%2C%202002).
[15] https://pmc.ncbi.nlm.nih.gov/articles/PMC4695694/ 
[16] https://pubmed.ncbi.nlm.nih.gov/12704213/ 
[17] https://jef.works/genomic-data-visualization-2024/course 
AI Prompts:
“For each cluster, I want to rank proteins by differential expression. Do a Wilcoxon test comparing (cluster i) vs (all other cells) for each protein column. Please write an efficient R implementation that returns a named vector of p-values per cluster,  sorted ascending, and prints the top 5 per cluster”
"I want 'top upregulated markers' not just lowest p-values. Compute mean difference (mean in cluster - mean out of cluster) per protein, filter to positive differences, then within those pick the 5 smallest p-values. Write the code for cluster 4 and 5 and return the top marker name for each."
“I have plots p1 to p10 and want two vertical stacks side-by-side (cluster 4 stack | cluster 5 stack), plus a single global title. Show the patchwork syntax using '/' for vertical and '|' for horizontal, and plot_annotation() for the title”

##Code

```r
library(ggplot2)
library(patchwork)
library(Rtsne)
library(dplyr)
library(reshape2)

# load and split data
data <- read.csv("~/Desktop/GDV/codex_spleen2.csv.gz", row.names = 1)
pos <- data[, 1:2]
area <- data[, 3]
pexp <- data[, 4:ncol(data)]

# QC filtering: remove bottom/top 1% by total signal and area
total_signal <- rowSums(pexp)
keep <- total_signal > quantile(total_signal, 0.01) & 
  total_signal < quantile(total_signal, 0.99) &
  area > quantile(area, 0.01) & 
  area < quantile(area, 0.99)
print(paste("Cells before QC:", nrow(data)))
print(paste("Cells after QC:", sum(keep)))
data <- data[keep, ]
pos <- data[, 1:2]
area <- data[, 3]
pexp <- data[, 4:ncol(data)]

# normalize: scale by total signal then log transform
pexpnorm <- log10(pexp / rowSums(pexp) * mean(rowSums(pexp)) + 1)

# PCA and scree plot to pick number of PCs for tSNE
pcs <- prcomp(pexpnorm)
plot(pcs$sdev[1:20], type = 'b', col = "steelblue",
     main = "PCA Scree Plot", xlab = "PC", ylab = "Standard Deviation")

# tSNE on first 18 PCs
set.seed(42)
emb <- Rtsne::Rtsne(pcs$x[, 1:18])$Y

# elbow plot to pick k, then run k-means with k=5
tw <- sapply(1:20, function(i) kmeans(emb, centers = i, nstart = 10, iter.max = 50)$tot.withinss)
plot(1:20, tw, type = 'b', col = "steelblue",
     main = "Elbow Plot for K-Means", xlab = "Number of Clusters (k)", ylab = "Total Within-Cluster SS")
set.seed(42)
com <- as.factor(kmeans(emb, centers = 5, nstart = 10, iter.max = 50)$cluster)
clusters <- data.frame(pexpnorm, pos, emb, com)

# wilcoxon test each cluster vs all others, print top 5 markers per cluster
results_list <- lapply(1:5, function(cluster_num) {
  sort(sapply(colnames(pexp), function(p) {
    wilcox.test(pexpnorm[com == cluster_num, p], 
                pexpnorm[com != cluster_num, p])$p.value
  }), decreasing = FALSE)
})
for(i in 1:5) {
  cat("\nCluster", i, "top markers:\n")
  print(head(results_list[[i]], 5))
}

# get top 5 upregulated markers: compute fold change, keep positive, re-sort by p-value
fc4 <- sapply(colnames(pexpnorm), function(p) mean(pexpnorm[com == 4, p]) - mean(pexpnorm[com != 4, p]))
fc5 <- sapply(colnames(pexpnorm), function(p) mean(pexpnorm[com == 5, p]) - mean(pexpnorm[com != 5, p]))
prots4 <- names(head(sort(results_list[[4]][names(which(fc4 > 0))]), 5))
prots5 <- names(head(sort(results_list[[5]][names(which(fc5 > 0))]), 5))
marker4 <- prots4[1]
marker5 <- prots5[1]
cat("Top marker for Cluster 4:", marker4, "\n")
cat("Top marker for Cluster 5:", marker5, "\n")

clusters$infour <- ifelse(clusters$com == 4, 1, 0)
clusters$infive <- ifelse(clusters$com == 5, 1, 0)

# cluster 4 plots
p1 <- ggplot(clusters) +
  geom_point(aes(x = X1, y = X2, col = as.factor(infour)), size = 0.01) +
  theme_bw() +
  scale_colour_manual(name = "Cluster", labels = c("Other", "Cluster 4"), 
                      values = c("lightgrey", "darkblue")) +
  xlab('tSNE-1') + ylab('tSNE-2') + labs(title = 'Cluster 4 on tSNE') +
  guides(colour = guide_legend(override.aes = list(size = 3)))

p2 <- ggplot(clusters) +
  geom_point(aes(x = x, y = y, col = as.factor(infour)), size = 0.02) +
  theme_bw() +
  scale_colour_manual(name = "Cluster", labels = c("Other", "Cluster 4"), 
                      values = c("lightgrey", "darkblue")) +
  xlab('X Position') + ylab('Y Position') + labs(title = 'Cluster 4 in Space') +
  guides(colour = guide_legend(override.aes = list(size = 3)))

p5 <- ggplot(clusters) +
  geom_point(aes(x = X1, y = X2, col = .data[[marker4]]), size = 0.01) +
  scale_colour_gradientn(colours = c("lightgrey", "mediumturquoise", "darkblue")) +
  labs(title = paste(marker4, "Expression on tSNE")) +
  xlab('tSNE-1') + ylab('tSNE-2') + theme_bw()

p6 <- ggplot(clusters) +
  geom_point(aes(x = x, y = y, col = .data[[marker4]]), size = 0.01) +
  scale_colour_gradientn(colours = c("lightgrey", "mediumturquoise", "darkblue")) +
  labs(title = paste(marker4, "Expression in Space")) +
  xlab('X Position') + ylab('Y Position') + theme_bw()

p9 <- ggplot(melt(data.frame(
  prot = prots4,
  incluster = sapply(prots4, function(p) mean(pexpnorm[com == 4, p])),
  outcluster = sapply(prots4, function(p) mean(pexpnorm[com != 4, p]))),
  id.vars = 'prot'), aes(x = prot, y = value, fill = variable)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  scale_fill_manual(name = 'Group', labels = c("In Cluster", "Other"),
                    values = c("darkblue", "lightgrey")) +
  labs(title = "Upregulated Proteins in Cluster 4") +
  xlab('Protein') + ylab('Mean Normalized Expression') + theme_bw()

# cluster 5 plots
p3 <- ggplot(clusters) +
  geom_point(aes(x = X1, y = X2, col = as.factor(infive)), size = 0.01) +
  theme_bw() +
  scale_colour_manual(name = "Cluster", labels = c("Other", "Cluster 5"), 
                      values = c("lightgrey", "darkred")) +
  xlab('tSNE-1') + ylab('tSNE-2') + labs(title = 'Cluster 5 on tSNE') +
  guides(colour = guide_legend(override.aes = list(size = 3)))

p4 <- ggplot(clusters) +
  geom_point(aes(x = x, y = y, col = as.factor(infive)), size = 0.02) +
  theme_bw() +
  scale_colour_manual(name = "Cluster", labels = c("Other", "Cluster 5"), 
                      values = c("lightgrey", "darkred")) +
  xlab('X Position') + ylab('Y Position') + labs(title = 'Cluster 5 in Space') +
  guides(colour = guide_legend(override.aes = list(size = 3)))

p7 <- ggplot(clusters) +
  geom_point(aes(x = X1, y = X2, col = .data[[marker5]]), size = 0.01) +
  scale_colour_gradientn(colours = c("lightgrey", "orange", "darkred")) +
  labs(title = paste(marker5, "Expression on tSNE")) +
  xlab('tSNE-1') + ylab('tSNE-2') + theme_bw()

p8 <- ggplot(clusters) +
  geom_point(aes(x = x, y = y, col = .data[[marker5]]), size = 0.01) +
  scale_colour_gradientn(colours = c("lightgrey", "orange", "darkred")) +
  labs(title = paste(marker5, "Expression in Space")) +
  xlab('X Position') + ylab('Y Position') + theme_bw()

p10 <- ggplot(melt(data.frame(
  prot = prots5,
  incluster = sapply(prots5, function(p) mean(pexpnorm[com == 5, p])),
  outcluster = sapply(prots5, function(p) mean(pexpnorm[com != 5, p]))),
  id.vars = 'prot'), aes(x = prot, y = value, fill = variable)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  scale_fill_manual(name = 'Group', labels = c("In Cluster", "Other"),
                    values = c("darkred", "lightgrey")) +
  labs(title = "Upregulated Proteins in Cluster 5") +
  xlab('Protein') + ylab('Mean Normalized Expression') + theme_bw()

# final figure: blue column (cluster 4) | red column (cluster 5)
((p1 / p5 / p2 / p6 / p9) | (p3 / p7 / p4 / p8 / p10)) +
  plot_annotation(title = "CODEX Spleen Analysis",
                  theme = theme(plot.title = element_text(size = 14, hjust = 0.5)))
ggsave("~/Desktop/GDV/hw4_ssingha9.png",
       width = 14,
       height = 10,
       dpi = 300)
```
